<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ room.title }} - Rave Bot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω */
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            background-color: var(--primary-dark);
            box-shadow: 0 4px 15px var(--shadow);
        }
        
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .notification {
            position: fixed;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: var(--text-light);
            padding: 12px 20px;
            border-radius: 25px;
            z-index: 1000;
            box-shadow: 0 4px 15px var(--shadow);
            transition: top 0.3s ease;
            border: 1px solid var(--pearlescent);
        }
        
        .notification.show {
            top: 20px;
        }
        
        .room-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .room-title-wrapper {
            display: flex;
            align-items: center;
        }
        
        .room-title-wrapper .room-title {
            margin-bottom: 0;
            margin-right: 10px;
        }
        
        .viewers-count {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 5px 12px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="text-center mb-4">
            <h1 class="pearlescent">Rave Bot</h1>
            <p>–°–æ–≤–º–µ—Å—Ç–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –≤–∏–¥–µ–æ –≤ Telegram</p>
        </header>

        <div class="card">
            <div class="room-info">
                <div class="room-title-wrapper">
                    <h2 class="room-title">{{ room.title }}</h2>
                    {% if is_creator %}
                        <span class="creator-badge">üëë</span>
                    {% endif %}
                </div>
                <div class="viewers-count">
                    <i class="fas fa-users"></i>
                    <span id="viewers-count">{{ room.viewers|length }}</span>
                </div>
            </div>
            
            <div class="video-container">
                <iframe src="{{ room.video_url }}" allowfullscreen></iframe>
            </div>
            
            <div class="action-buttons">
                <button id="share-btn" class="btn secondary">
                    <i class="fas fa-share-alt"></i> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                </button>
                
                {% if is_creator %}
                    <button id="change-video-btn" class="btn primary">
                        <i class="fas fa-exchange-alt"></i> –°–º–µ–Ω–∏—Ç—å –≤–∏–¥–µ–æ
                    </button>
                {% endif %}
                
                <a href="{{ url_for('index') }}" class="btn">
                    <i class="fas fa-home"></i> –ù–∞ –≥–ª–∞–≤–Ω—É—é
                </a>
            </div>
        </div>

        <div class="card">
            <h2>–ß–∞—Ç –∫–æ–º–Ω–∞—Ç—ã</h2>
            
            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    {% for message in room.messages %}
                        <div class="message {% if message.user_id == user_id %}outgoing{% endif %}">
                            <div class="message-bubble">{{ message.text }}</div>
                            <div class="message-info">
                                {{ message.user_name }}, {{ message.timestamp|format_time }}
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <form class="chat-input" id="chat-form">
                    <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." {% if is_banned %}disabled{% endif %}>
                    <button type="submit" {% if is_banned %}disabled{% endif %}>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
            
            {% if is_banned %}
                <div class="text-center mt-4">
                    <p class="danger-text">–í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –≤ —ç—Ç–æ–π –∫–æ–º–Ω–∞—Ç–µ –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è.</p>
                </div>
            {% endif %}
        </div>
        
        {% if is_creator %}
            <div class="card">
                <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç–æ–π</h2>
                
                <div class="form-group">
                    <label for="new-video-url">–°—Å—ã–ª–∫–∞ –Ω–∞ –Ω–æ–≤–æ–µ –≤–∏–¥–µ–æ</label>
                    <input type="text" id="new-video-url" class="form-control" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ">
                </div>
                
                <button id="update-video-btn" class="btn primary">
                    <i class="fas fa-save"></i> –û–±–Ω–æ–≤–∏—Ç—å –≤–∏–¥–µ–æ
                </button>
                
                <div class="mt-4">
                    <h3>–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
                    {% if room.banned_users %}
                        <ul class="banned-list">
                            {% for user_id in room.banned_users %}
                                <li>
                                    ID: {{ user_id }}
                                    <button class="btn danger unban-btn" data-user-id="{{ user_id }}">
                                        –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                                    </button>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>–ù–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.</p>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>

    <div id="share-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–æ–º–Ω–∞—Ç–æ–π</h2>
            <p>–û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –¥—Ä—É–∑—å—è–º, —á—Ç–æ–±—ã –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å –∏—Ö –≤ –∫–æ–º–Ω–∞—Ç—É:</p>
            <div class="form-group">
                <input type="text" id="share-link" class="form-control" value="{{ share_link }}" readonly>
            </div>
            <button id="copy-link-btn" class="btn primary">
                <i class="fas fa-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
            </button>
        </div>
    </div>

    <script src="{{ url_for('static', filename='scripts.js') }}"></script>
    <script>
        // –ö–æ–¥ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º
        const shareBtn = document.getElementById('share-btn');
        const shareModal = document.getElementById('share-modal');
        const closeBtn = document.querySelector('.close');
        const copyLinkBtn = document.getElementById('copy-link-btn');
        const shareLink = document.getElementById('share-link');
        
        if (shareBtn) {
            shareBtn.addEventListener('click', () => {
                playSound('click');
                shareModal.style.display = 'block';
            });
        }
        
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                shareModal.style.display = 'none';
            });
        }
        
        window.addEventListener('click', (e) => {
            if (e.target === shareModal) {
                shareModal.style.display = 'none';
            }
        });
        
        if (copyLinkBtn) {
            copyLinkBtn.addEventListener('click', () => {
                playSound('success');
                shareLink.select();
                document.execCommand('copy');
                
                // –ò–∑–º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –Ω–∞ –≤—Ä–µ–º—è
                const originalText = copyLinkBtn.innerHTML;
                copyLinkBtn.innerHTML = '<i class="fas fa-check"></i> –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                
                setTimeout(() => {
                    copyLinkBtn.innerHTML = originalText;
                }, 2000);
            });
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–µ–æ (–¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∫–æ–º–Ω–∞—Ç—ã)
        const updateVideoBtn = document.getElementById('update-video-btn');
        const newVideoUrlInput = document.getElementById('new-video-url');
        
        if (updateVideoBtn && newVideoUrlInput) {
            updateVideoBtn.addEventListener('click', () => {
                const newUrl = newVideoUrlInput.value.trim();
                
                if (newUrl) {
                    playSound('click');
                    
                    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç AJAX-–∑–∞–ø—Ä–æ—Å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–¥–µ–æ
                    fetch('/update_video', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            room_id: '{{ room.id }}',
                            video_url: newUrl
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            playSound('success');
                            // –û–±–Ω–æ–≤–ª—è–µ–º iframe —Å –≤–∏–¥–µ–æ
                            document.querySelector('.video-container iframe').src = newUrl;
                            newVideoUrlInput.value = '';
                            
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                            const notification = document.createElement('div');
                            notification.className = 'notification';
                            notification.innerText = '–í–∏–¥–µ–æ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!';
                            
                            document.body.appendChild(notification);
                            
                            setTimeout(() => {
                                notification.classList.add('show');
                            }, 10);
                            
                            setTimeout(() => {
                                notification.classList.remove('show');
                                setTimeout(() => {
                                    notification.remove();
                                }, 300);
                            }, 3000);
                        } else {
                            playSound('error');
                            alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–¥–µ–æ: ' + data.error);
                        }
                    })
                    .catch(error => {
                        playSound('error');
                        console.error('–û—à–∏–±–∫–∞:', error);
                        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤–∏–¥–µ–æ.');
                    });
                }
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const chatMessages = document.getElementById('chat-messages');
        
        if (chatForm && messageInput && chatMessages) {
            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const message = messageInput.value.trim();
                
                if (message) {
                    playSound('message');
                    
                    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç AJAX-–∑–∞–ø—Ä–æ—Å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
                    fetch('/send_message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            room_id: '{{ room.id }}',
                            message: message
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // –°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ, –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                            messageInput.value = '';
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
                            addMessage(message, true);
                        } else {
                            playSound('error');
                            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + data.error);
                        }
                    })
                    .catch(error => {
                        playSound('error');
                        console.error('–û—à–∏–±–∫–∞:', error);
                        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è.');
                    });
                }
            });
        }
        
        // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        const unbanButtons = document.querySelectorAll('.unban-btn');
        
        unbanButtons.forEach(button => {
            button.addEventListener('click', () => {
                const userId = button.dataset.userId;
                
                if (userId) {
                    playSound('click');
                    
                    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç AJAX-–∑–∞–ø—Ä–æ—Å –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    fetch('/unban_user', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            room_id: '{{ room.id }}',
                            user_id: userId
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            playSound('success');
                            // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ —Å–ø–∏—Å–∫–∞
                            button.parentElement.remove();
                            
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                            const notification = document.createElement('div');
                            notification.className = 'notification';
                            notification.innerText = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!';
                            
                            document.body.appendChild(notification);
                            
                            setTimeout(() => {
                                notification.classList.add('show');
                            }, 10);
                            
                            setTimeout(() => {
                                notification.classList.remove('show');
                                setTimeout(() => {
                                    notification.remove();
                                }, 300);
                            }, 3000);
                        } else {
                            playSound('error');
                            alert('–û—à–∏–±–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + data.error);
                        }
                    })
                    .catch(error => {
                        playSound('error');
                        console.error('–û—à–∏–±–∫–∞:', error);
                        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');
                    });
                }
            });
        });
    </script>
</body>
</html> 