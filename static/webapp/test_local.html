<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rave Bot - –¢–µ—Å—Ç–æ–≤–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ</title>
    <link rel="stylesheet" href="tgstyle.css">
    <style>
        .test-panel {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 10px;
            z-index: 9999;
            font-size: 14px;
        }
        
        .test-panel h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        
        .test-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .test-btn {
            background: #333;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .test-btn:hover {
            background: #555;
        }
        
        /* –ò–º–∏—Ç–∞—Ü–∏—è Telegram WebApp */
        #telegram-web-app-placeholder {
            display: none;
        }
    </style>
    <script>
        // –ú–æ–∫ –¥–ª—è Telegram WebApp API
        window.Telegram = {
            WebApp: {
                ready: function() { console.log('WebApp ready called'); },
                expand: function() { console.log('WebApp expand called'); },
                colorScheme: 'light',
                MainButton: {
                    text: 'Button',
                    isVisible: false,
                    setText: function(text) { 
                        this.text = text; 
                        console.log('MainButton setText:', text);
                        document.getElementById('main-button-text').textContent = text;
                    },
                    show: function() { 
                        this.isVisible = true; 
                        console.log('MainButton show');
                        document.getElementById('tg-main-button').style.display = 'block';
                    },
                    hide: function() { 
                        this.isVisible = false; 
                        console.log('MainButton hide');
                        document.getElementById('tg-main-button').style.display = 'none';
                    },
                    showProgress: function() { 
                        console.log('MainButton showProgress');
                        document.getElementById('main-button-progress').style.display = 'inline-block';
                    },
                    hideProgress: function() { 
                        console.log('MainButton hideProgress');
                        document.getElementById('main-button-progress').style.display = 'none';
                    },
                    onClick: function(callback) {
                        document.getElementById('tg-main-button').addEventListener('click', callback);
                    }
                },
                BackButton: {
                    isVisible: false,
                    show: function() { 
                        this.isVisible = true; 
                        console.log('BackButton show');
                        document.getElementById('tg-back-button').style.display = 'block';
                    },
                    hide: function() { 
                        this.isVisible = false; 
                        console.log('BackButton hide');
                        document.getElementById('tg-back-button').style.display = 'none';
                    },
                    onClick: function(callback) {
                        document.getElementById('tg-back-button').addEventListener('click', callback);
                    }
                },
                showPopup: function(params) {
                    console.log('showPopup called:', params);
                    alert(params.title + '\n\n' + params.message);
                },
                showAlert: function(message) {
                    console.log('showAlert called:', message);
                    alert(message);
                },
                switchInlineQuery: function(query, targets) {
                    console.log('switchInlineQuery called:', query, targets);
                    alert('–ü–æ–¥–µ–ª–∏—Ç—å—Å—è: ' + query);
                }
            }
        };

        // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã
        const testRoom = {
            id: "room123",
            title: "–¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞",
            video_url: "https://www.youtube.com/embed/dQw4w9WgXcQ",
            messages: [
                {
                    user_id: "user1",
                    user_name: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 1",
                    text: "–ü—Ä–∏–≤–µ—Ç –≤—Å–µ–º!",
                    timestamp: Math.floor(Date.now() / 1000) - 600
                },
                {
                    user_id: "user2",
                    user_name: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 2",
                    text: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!",
                    timestamp: Math.floor(Date.now() / 1000) - 500
                }
            ],
            viewers: [
                { id: "user1", name: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 1" },
                { id: "user2", name: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 2" },
                { id: "user3", name: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 3" }
            ]
        };

        // –≠–º—É–ª—è—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ API
        function mockApiResponse(url, data) {
            return new Promise((resolve) => {
                console.log('Mock API call to:', url, 'with data:', data);
                
                // –ò–º–∏—Ç–∏—Ä—É–µ–º –∑–∞–¥–µ—Ä–∂–∫—É —Å–µ—Ç–∏
                setTimeout(() => {
                    if (url.includes('/send_message')) {
                        resolve({
                            success: true,
                            message: {
                                user_id: "user3",
                                user_name: "–í—ã",
                                text: data.message,
                                timestamp: Math.floor(Date.now() / 1000)
                            }
                        });
                    } else if (url.includes('/update_video')) {
                        resolve({
                            success: true,
                            need_vpn: data.video_url.includes('youtube')
                        });
                    } else if (url.includes('/sync_video')) {
                        resolve({
                            success: true
                        });
                    } else if (url.includes('/get_messages')) {
                        resolve({
                            success: true,
                            messages: []
                        });
                    } else if (url.includes('/check_sync')) {
                        resolve({
                            success: true,
                            need_sync: false,
                            time: 0
                        });
                    } else {
                        resolve({
                            success: false,
                            error: "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å"
                        });
                    }
                }, 300);
            });
        }

        // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º fetch –¥–ª—è —ç–º—É–ª—è—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤ —Å–µ—Ä–≤–µ—Ä–∞
        const originalFetch = window.fetch;
        window.fetch = function(url, options) {
            if (url.toString().includes('/webapp/')) {
                let data = {};
                if (options && options.body) {
                    try {
                        data = JSON.parse(options.body);
                    } catch (e) {
                        console.error('Error parsing body:', e);
                    }
                }
                return mockApiResponse(url, data).then(response => {
                    return {
                        ok: true,
                        json: () => Promise.resolve(response)
                    };
                });
            }
            return originalFetch(url, options);
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function init() {
            // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–æ–º–Ω–∞—Ç—ã
            const isRoomPage = window.location.hash === '#room';
            
            // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–æ —Å–ø–∏—Å–∫–æ–º –∫–æ–º–Ω–∞—Ç
            const isIndexPage = !isRoomPage;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —à–∞–±–ª–æ–Ω
            if (isRoomPage) {
                document.body.innerHTML = generateRoomTemplate(testRoom);
                document.body.setAttribute('data-room-id', testRoom.id);
                document.body.setAttribute('data-room-title', testRoom.title);
                document.body.setAttribute('data-is-creator', 'true');
                document.body.setAttribute('data-is-banned', 'false');
                document.body.setAttribute('data-user-id', 'user3');
                document.body.setAttribute('data-bot-username', 'test_bot');
                
                // –≠–º—É–ª–∏—Ä—É–µ–º –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ Jinja
                window.userIdStr = "user3";
                window.roomIdStr = testRoom.id;
                window.isCreatorStr = "true";
                window.isBannedStr = "false";
                window.botUsername = "test_bot";
            } else {
                document.body.innerHTML = generateIndexTemplate([testRoom]);
                document.body.setAttribute('data-user-id', 'user3');
                
                // –≠–º—É–ª–∏—Ä—É–µ–º –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ Jinja
                window.userIdStr = "user3";
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            appendTestPanel(isRoomPage);
            
            // –≠–º—É–ª–∏—Ä—É–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é Telegram WebApp
            if (isRoomPage) {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–∫—Ä–∏–ø—Ç room.js
                const script = document.createElement('script');
                script.src = 'room.js';
                document.body.appendChild(script);
            }
        }

        // –®–∞–±–ª–æ–Ω –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–æ–º–Ω–∞—Ç—ã
        function generateRoomTemplate(room) {
            return `
            <div id="telegram-web-app-placeholder">
                <button id="tg-back-button" style="display: none;">–ù–∞–∑–∞–¥</button>
                <button id="tg-main-button" style="display: none;">
                    <span id="main-button-text">–ö–Ω–æ–ø–∫–∞</span>
                    <span id="main-button-progress" style="display: none;">‚è≥</span>
                </button>
            </div>
            
            <div class="container">
                <div class="header">
                    <h1 class="header-title">${room.title}</h1>
                    <p class="header-subtitle">
                        –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${room.viewers.length}
                        <span class="creator-badge"> ‚Ä¢ –í—ã —Å–æ–∑–¥–∞—Ç–µ–ª—å</span>
                    </p>
                </div>

                <div class="video-container" id="video-container" data-video-url="${room.video_url}">
                    <iframe src="${room.video_url}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>

                <div class="video-controls">
                    <button id="sync-btn" class="tg-button">
                        <span class="icon-sync">‚è±Ô∏è</span> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                    
                    <button id="change-video-btn" class="tg-button primary">
                        <span class="icon-change">üé¨</span> –°–º–µ–Ω–∏—Ç—å –≤–∏–¥–µ–æ
                    </button>
                </div>

                <h2 class="section-title">–ß–∞—Ç –∫–æ–º–Ω–∞—Ç—ã</h2>
                
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages">
                        ${room.messages.map(msg => `
                            <div class="message ${msg.user_id === 'user3' ? 'outgoing' : ''}" data-timestamp="${msg.timestamp}" data-user-id="${msg.user_id}">
                                <div class="message-bubble">${msg.text}</div>
                                <div class="message-info">
                                    ${msg.user_name}, ${formatTimeForDisplay(msg.timestamp)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <form class="chat-input" id="chat-form">
                        <input type="text" id="message-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
                        <button type="submit">
                            <span class="icon-send">üì§</span>
                        </button>
                    </form>
                </div>
                
                <div class="invite-section">
                    <button id="share-btn" class="tg-button primary wide-button">
                        <span class="icon-share">üîó</span> –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π
                    </button>
                </div>
            </div>
            
            <div class="modal" id="change-video-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>–°–º–µ–Ω–∏—Ç—å –≤–∏–¥–µ–æ</h2>
                        <button class="close-btn" id="close-video-modal-btn">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="change-video-form">
                            <div class="form-group">
                                <label for="new_video_url">–°—Å—ã–ª–∫–∞ –Ω–∞ –Ω–æ–≤–æ–µ –≤–∏–¥–µ–æ</label>
                                <input type="text" id="new_video_url" name="new_video_url" class="tg-input" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ" required>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="tg-button primary">–û–±–Ω–æ–≤–∏—Ç—å –≤–∏–¥–µ–æ</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>`;
        }

        // –®–∞–±–ª–æ–Ω –¥–ª—è –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function generateIndexTemplate(rooms) {
            return `
            <div id="telegram-web-app-placeholder">
                <button id="tg-back-button" style="display: none;">–ù–∞–∑–∞–¥</button>
                <button id="tg-main-button" style="display: none;">
                    <span id="main-button-text">–ö–Ω–æ–ø–∫–∞</span>
                    <span id="main-button-progress" style="display: none;">‚è≥</span>
                </button>
            </div>
            
            <div class="container">
                <header class="header">
                    <h1 class="header-title">Rave Bot</h1>
                    <p class="header-subtitle">–°–æ–≤–º–µ—Å—Ç–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –≤–∏–¥–µ–æ</p>
                </header>

                <div class="rooms-section">
                    <h2 class="section-title">–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã</h2>
                    
                    <div class="rooms-list" id="rooms-list">
                        ${rooms.map(room => `
                            <div class="room-card" data-room-id="${room.id}">
                                <div class="room-header">
                                    <div class="room-title">${room.title}</div>
                                    <div class="room-viewers">
                                        <i class="icon-users">üë•</i> ${room.viewers.length}
                                    </div>
                                </div>
                                <div class="room-video">
                                    <i class="icon-video">üé¨</i> ${room.video_url}
                                </div>
                                <div class="room-actions">
                                    <button class="tg-button join-room-btn" data-room-id="${room.id}">
                                        –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>

            <div class="modal" id="create-room-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</h2>
                        <button class="close-btn" id="close-modal-btn">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="create-room-form">
                            <div class="form-group">
                                <label for="video_url">–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ</label>
                                <input type="text" id="video_url" name="video_url" class="tg-input" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="title">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                                <input type="text" id="title" name="title" class="tg-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã">
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="tg-button primary">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>`;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function appendTestPanel(isRoomPage) {
            const panel = document.createElement('div');
            panel.className = 'test-panel';
            
            panel.innerHTML = `
                <h3>–¢–µ—Å—Ç–æ–≤–∞—è –ø–∞–Ω–µ–ª—å</h3>
                <div class="test-controls">
                    <button class="test-btn" id="test-toggle-theme">–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É</button>
                    ${isRoomPage ? `
                        <button class="test-btn" id="test-add-message">–î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
                        <button class="test-btn" id="test-sync-video">–≠–º—É–ª—è—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</button>
                        <a href="#" class="test-btn">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
                    ` : `
                        <a href="#room" class="test-btn">–í –∫–æ–º–Ω–∞—Ç—É</a>
                    `}
                </div>
            `;
            
            document.body.appendChild(panel);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
            document.getElementById('test-toggle-theme').addEventListener('click', function() {
                const newTheme = document.body.className === 'dark' ? 'light' : 'dark';
                document.body.className = newTheme;
                window.Telegram.WebApp.colorScheme = newTheme;
            });
            
            if (isRoomPage) {
                document.getElementById('test-add-message').addEventListener('click', function() {
                    // –≠–º—É–ª—è—Ü–∏—è –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                    const messages = [
                        { user_id: 'user1', username: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 1', text: '–ù–æ–≤–æ–µ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!', timestamp: Math.floor(Date.now() / 1000) },
                        { user_id: 'user2', username: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 2', text: '–ü—Ä–∏–≤–µ—Ç –≤—Å–µ–º!', timestamp: Math.floor(Date.now() / 1000) }
                    ];
                    const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                    
                    if (typeof addMessageToChat === 'function') {
                        addMessageToChat(randomMessage);
                    } else {
                        // –†—É—á–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
                        const chatMessages = document.getElementById('chat-messages');
                        if (chatMessages) {
                            const messageEl = document.createElement('div');
                            messageEl.className = 'message';
                            messageEl.setAttribute('data-timestamp', randomMessage.timestamp);
                            messageEl.setAttribute('data-user-id', randomMessage.user_id);
                            
                            messageEl.innerHTML = `
                                <div class="message-bubble">${randomMessage.text}</div>
                                <div class="message-info">
                                    ${randomMessage.username}, ${formatTimeForDisplay(randomMessage.timestamp)}
                                </div>
                            `;
                            
                            chatMessages.appendChild(messageEl);
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }
                    }
                });
                
                document.getElementById('test-sync-video').addEventListener('click', function() {
                    // –≠–º—É–ª—è—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤–∏–¥–µ–æ
                    if (typeof showToast === 'function') {
                        showToast('–í–∏–¥–µ–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
                    } else {
                        alert('–í–∏–¥–µ–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
                    }
                });
            }
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function formatTimeForDisplay(timestamp) {
            const date = new Date(timestamp * 1000);
            return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        }

        // –ó–∞–ø—É—Å–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', init);
        
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ö—ç—à–∞ –≤ URL
        window.addEventListener('hashchange', function() {
            location.reload();
        });
    </script>
</head>
<body>
    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ JavaScript -->
    <div style="display: flex; justify-content: center; align-items: center; height: 100vh;">
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è...</p>
    </div>
</body>
</html> 